<!DOCTYPE html>
<html>
  <head>
    <title>Apple IIjs</title>
    <meta name="viewport" content="width=602, user-scalable=no" />

    <link rel="stylesheet" type="text/css" href="css/apple2.css" />
    <script type="text/javascript" src="json/disks/index.js"></script>
  </head>
  <body class="apple2e">
    <div style="margin: auto; width: 602px">
      <img id="badge" src="img/badge.png" />
      <h1 id="subtitle">An Apple ][ Emulator in JavaScript</h1>
      <div class="overscan">
        <canvas width="560" height="384" id="screen" />
      </div>
      <div class="inset">
        <div style="float: left; width: 50%">
          <div class="disk" id="disk1">&nbsp;</div>
          <span id="disklabel1" class="disklabel">Disk 1</span>
        </div>
        <div style="float: left; width: 50%">
          <div class="disk" id="disk2">&nbsp;</div>
          <span id="disklabel2" class="disklabel">Disk 2</span>
        </div>
        <div style="clear: both"></div>
      </div>
      <div>
        <button onclick="main.reset()" id="reset">
          RESET
        </button>
        <div style="clear: both"></div>
      </div>
      <div id="keyboard">
      </div>
    </div>
    <script type="text/javascript" src="module.js"></script>
    <script type="text/javascript">
    {
        var main = require('./js/main.js');
        var disk2 = main.getDiskII();

        function loadHTTP(url, drive) {
            var parts = url.split(/[\/\.]/);
            var name = decodeURIComponent(parts[parts.length - 2]);
            var ext = parts[parts.length - 1].toLowerCase();
            var label = document.querySelector('#disklabel' + drive);

            console.log('Loading', url, 'into drive', drive);
            var req = new XMLHttpRequest();
            req.open('GET', url, true);

            if (ext == 'json') {
                req.onload = function(e) {
                    var json;
                    try {
                        json = JSON.parse(req.responseText);
                        if (disk2.setDisk(drive, json)) {
                            label.innerHTML = json.name;
                        }
                    } catch (e) {
                        alert('Sorry, couldn\'t read "' + url + '"');
                    }
                };
            } else {
                req.responseType = 'arraybuffer';

                req.onload = function(e) {
                    if (disk2.setBinary(drive, name, ext, req.response)) {
                        label.innerHTML = name;
                    }
                };
            }
            req.onerror = function(e) {
                alert('Sorry, couldn\'t load "' + url + '"');
            }
            req.send();
        }

        var hash = document.location.hash;
        if (hash) {
            var url = hash.substr(1);
            loadHTTP(url, 1);
        }

        disk2.addDriveLightListener(function(drive, on) {
            var disk = document.getElementById('disk' + drive);
            disk.style.backgroundImage = on ?
                'url(img/red-on-16.png)' : 'url(img/red-off-16.png)';
        });
    }
    </script>
  </body>
</html>
